<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เครื่องมือจัดการไฟล์ Excel (ปรับปรุงแล้ว)</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jQuery Library -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- SheetJS library for Excel file manipulation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- SweetAlert2 for beautiful alerts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Google Fonts: Sarabun -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- General Styling --- */
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f3f4f6; /* Lighter gray background */
        }
        ::selection {
            background-color: #3b82f6;
            color: white;
        }

        /* --- Table Container & Scrolling --- */
        #table-container {
            max-height: 65vh; /* Increased height */
            overflow: auto;
            user-select: none;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
        }
        #excel-table {
            border-collapse: collapse;
            width: 100%;
        }

        /* --- Table Cells & Headers --- */
        #excel-table th, #excel-table td {
            border: 1px solid #d1d5db;
            padding: 0.5rem;
            min-width: 120px;
            font-size: 0.875rem;
            text-align: left;
            white-space: nowrap;
            transition: font-size 0.2s ease, padding 0.2s ease;
        }
        #excel-table td {
            background-color: white;
        }
        #excel-table td:focus, #excel-table th:focus {
            background-color: #eff6ff;
            outline: 2px solid #2563eb;
        }
        
        /* --- Sticky Header & Filter Row Styling (IMPROVED) --- */
        #excel-table thead th {
            position: sticky;
            background-color: #f3f4f6; /* Consistent background */
            z-index: 10;
        }
        #excel-table thead tr:first-child th {
            top: 0; /* Header row sticks to the top */
        }
        #excel-table thead .filter-row th {
            /* 'top' is set dynamically by JavaScript */
            z-index: 9;
            /* padding: 2px; */
        }
        
        /* --- Sticky Row/Column Number Styling --- */
        #excel-table thead th:first-child,
        #excel-table tbody th {
            position: sticky;
            left: 0;
            z-index: 20; /* Higher z-index to stay on top */
            background-color: #f9fafb;
            min-width: 50px;
            width: 50px;
            text-align: center;
        }
        #excel-table thead th:hover,
        #excel-table tbody th:hover {
            background-color: #e5e7eb;
            cursor: pointer;
        }

        /* --- Selection & Freezing Styling --- */
        #excel-table td.selected, 
        #excel-table th.selected-header {
            background-color: #dbeafe;
            border-color: #93c5fd;
        }
        .frozen-row {
            position: sticky;
            z-index: 15 !important;
            background-color: #eef2f7 !important;
        }
        .frozen-col {
            position: sticky;
            z-index: 15 !important;
            background-color: #eef2f7 !important;
        }
        .frozen-corner {
            position: sticky;
            z-index: 25 !important; /* Highest z-index */
            background-color: #e2e8f0 !important;
        }

        /* --- UI Components Styling (Tabs, Toolbar, etc.) --- */
        .drag-over {
            border-color: #2563eb;
            background-color: #eff6ff;
        }
        .tab-button.active {
            border-color: #2563eb;
            background-color: #3b82f6;
            color: white;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .sheet-tab {
            padding: 0.375rem 0.875rem;
            font-size: 0.875rem;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            color: #6b7280;
            white-space: nowrap;
        }
        .sheet-tab:hover {
            background-color: #f3f4f6;
            color: #111827;
        }
        .sheet-tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
            font-weight: 600;
        }
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            padding: 0.5rem;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }
        .icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2.25rem;
            height: 2.25rem;
            border-radius: 0.375rem;
            color: #4b5563;
            position: relative;
        }
        .icon-btn:hover {
            background-color: #e5e7eb;
            color: #1f2937;
        }
        .icon-btn svg {
            width: 1.25rem;
            height: 1.25rem;
        }
        .icon-btn .tooltip {
            visibility: hidden;
            width: max-content;
            background-color: #1f2937;
            color: #fff;
            text-align: center;
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            position: absolute;
            z-index: 20;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 0.75rem;
        }
        .icon-btn:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        /* --- Filter Dropdown Styles --- */
        .filter-btn.active svg { color: #2563eb; }
        .filter-dropdown {
            position: absolute;
            z-index: 30;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            width: 280px;
        }
        .filter-values-list {
            max-height: 200px;
            overflow-y: auto;
            padding: 0.25rem 0.5rem;
        }
        .filter-item {
            display: flex;
            align-items: center;
            padding: 0.25rem;
            font-size: 0.875rem;
            cursor: pointer;
            border-radius: 4px;
        }
        .filter-item:hover { background-color: #f3f4f6; }
        .filter-item input { margin-right: 0.5rem; }
    </style>
</head>
<body class="p-2 sm:p-4">

    <div class="w-full max-w-7xl mx-auto">
        <header class="text-center mb-6 bg-white p-4 md:p-6 rounded-xl shadow-lg">
            <h1 class="text-2xl md:text-4xl font-bold text-gray-800">เครื่องมือจัดการไฟล์ Excel</h1>
            <p class="text-gray-500 mt-2 text-sm md:text-base">แปลงไฟล์, แก้ไขข้อมูลในตาราง, และส่งออกเป็นรูปแบบที่คุณต้องการ</p>
        </header>

        <!-- Tab Buttons -->
        <div class="mb-4 flex justify-center border-b border-gray-200">
            <button id="tab-btn-convert" class="tab-button active text-base md:text-lg font-medium py-3 px-4 md:px-6 border-b-4">แปลงไฟล์ด่วน</button>
            <button id="tab-btn-edit" class="tab-button text-base md:text-lg font-medium py-3 px-4 md:px-6 border-b-4 border-transparent text-gray-500 hover:text-gray-800">แก้ไขและส่งออก</button>
        </div>

        <!-- Tab Content Area -->
        <div id="tab-content-area">
            <!-- Quick Convert Tab -->
            <div id="content-convert" class="tab-content active">
                 <div class="bg-white rounded-xl shadow-lg p-4 md:p-8">
                    <div id="drop-zone-convert" class="border-4 border-dashed border-gray-300 rounded-xl p-8 md:p-12 text-center cursor-pointer hover:border-blue-500">
                        <div class="flex flex-col items-center justify-center text-gray-500">
                            <svg class="w-16 h-16 mb-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3 3m3-3l3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" /></svg>
                            <p class="font-semibold">ลากไฟล์ .xlsx มาวางที่นี่เพื่อแปลงเป็น .xls</p>
                        </div>
                        <input type="file" id="file-input-convert" class="hidden" accept=".xlsx" multiple="false">
                    </div>
                </div>
                <div id="history-container" class="bg-white rounded-xl shadow-lg p-4 md:p-8 mt-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl md:text-2xl font-bold text-gray-800">ประวัติการแปลงไฟล์</h2>
                        <button id="clear-history-btn" class="text-sm text-red-500 hover:text-red-700 font-medium">ล้างประวัติ</button>
                    </div>
                    <div class="text-center text-gray-500 p-4" id="empty-history-message"><p>ยังไม่มีประวัติการแปลงไฟล์</p></div>
                    <ul id="history-list" class="space-y-3"></ul>
                </div>
            </div>

            <!-- Edit & Export Tab -->
            <div id="content-edit" class="tab-content">
                <div class="bg-white rounded-xl shadow-lg p-4 md:p-8">
                    <div id="edit-area">
                        <div id="drop-zone-edit" class="border-4 border-dashed border-gray-300 rounded-xl p-8 md:p-12 text-center cursor-pointer hover:border-blue-500">
                            <div class="flex flex-col items-center justify-center text-gray-500">
                                <svg class="w-16 h-16 mb-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                                <p class="font-semibold">ลากไฟล์ .xlsx .xls หรือ .csv มาวางที่นี่เพื่อแก้ไข</p>
                            </div>
                            <input type="file" id="file-input-edit" class="hidden" accept=".xlsx, .xls, .csv" multiple="false">
                        </div>
                        <div id="editor-view" class="hidden">
                            <!-- Toolbar -->
                            <div class="toolbar mb-4">
                                <div class="flex flex-wrap items-center gap-2">
                                    <div class="flex items-center gap-1">
                                        <button onclick="resetEditor()" class="icon-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                                            <span class="tooltip">ไฟล์ใหม่</span>
                                        </button>
                                    </div>
                                    <div class="w-px h-6 bg-gray-300 mx-1"></div>
                                    <div class="flex items-center gap-1">
                                        <button onclick="undo()" class="icon-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" /></svg><span class="tooltip">ย้อนกลับ (Ctrl+Z)</span></button>
                                        <button onclick="redo()" class="icon-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 15l6-6m0 0l-6-6m6 6H9a6 6 0 000 12h3" /></svg><span class="tooltip">ทำซ้ำ (Ctrl+Y)</span></button>
                                    </div>
                                    <div class="w-px h-6 bg-gray-300 mx-1"></div>
                                    <div class="flex items-center gap-1">
                                        <button onclick="copySelectedData()" class="icon-btn"><svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M18 3a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-1V9a4 4 0 0 0-4-4h-3a1.99 1.99 0 0 0-1 .267V5a2 2 0 0 1 2-2h7Z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M8 7.054V11H4.2a2 2 0 0 1 .281-.432l2.46-2.87A2 2 0 0 1 8 7.054ZM10 7v4a2 2 0 0 1-2 2H4v6a2 2 0 0 0 2 2h7a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3Z" clip-rule="evenodd"/></svg><span class="tooltip">คัดลอก (Ctrl+C)</span></button>
                                        <button onclick="pasteData()" class="icon-btn"><svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20H5a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h2.429M7 8h3M8 8V4h4v2m4 0V5h-4m3 4v3a1 1 0 0 1-1 1h-3m9-3v9a1 1 0 0 1-1 1h-7a1 1 0 0 1-1-1v-6.397a1 1 0 0 1 .27-.683l2.434-2.603a1 1 0 0 1 .73-.317H19a1 1 0 0 1 1 1Z"/></svg><span class="tooltip">วาง (Ctrl+V)</span></button>
                                    </div>
                                    <div class="w-px h-6 bg-gray-300 mx-1"></div>
                                    <div class="flex items-center gap-1">
                                        <button onclick="mergeSelectedCells()" class="icon-btn"><svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 18v2H4V4h6v2m4 12v2h6V4h-6v2m-6.49543 8.4954L10 12m0 0L7.50457 9.50457M10 12H4.05191m12.50199 2.5539L14 12m0 0 2.5539-2.55392M14 12h5.8319"/></svg><span class="tooltip">ผสานเซลล์</span></button>
                                        <button onclick="unmergeSelectedCells()" class="icon-btn"><svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.5045 14.4954 21 12m0 0-2.4955-2.49542M21 12h-5.9481m-9.49798 2.5539L3 12m0 0 2.55392-2.55392M3 12h5.83192m.16807 7V5H15v14H8.99999Z"/></svg><span class="tooltip">ยกเลิกผสาน</span></button>
                                    </div>
                                    <div class="w-px h-6 bg-gray-300 mx-1"></div>
                                    <div class="flex items-center gap-1">
                                        <button onclick="insertRow('above')" class="icon-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M3 14h18m-9-11v4m0 0v4m0-4h4m-4 0H8" /></svg><span class="tooltip">แทรกแถวด้านบน</span></button>
                                        <button onclick="insertRow('below')" class="icon-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 6h18M3 10h18m-9 7v-4m0 0v-4m0 4h4m-4 0H8" /></svg><span class="tooltip">แทรกแถวด้านล่าง</span></button>
                                        <button onclick="deleteSelectedRows()" class="icon-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg><span class="tooltip">ลบแถว</span></button>
                                        <div class="w-px h-4 bg-gray-300 mx-1"></div>
                                        <button onclick="insertColumn('left')" class="icon-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14 3v18H10V3m-7 9h4m0 0h4m-4 0v-4m0 4v4" /></svg><span class="tooltip">แทรกคอลัมน์ซ้าย</span></button>
                                        <button onclick="insertColumn('right')" class="icon-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10 3v18H6V3m11 9h-4m0 0h-4m4 0v-4m0 4v4" /></svg><span class="tooltip">แทรกคอลัมน์ขวา</span></button>
                                        <button onclick="deleteSelectedColumns()" class="icon-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg><span class="tooltip">ลบคอลัมน์</span></button>
                                    </div>
                                </div>
                                <div class="flex flex-wrap items-center gap-2">
                                    <div class="flex items-center gap-1">
                                        <button onclick="freezePanes()" class="icon-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 14.25h13.5m-13.5 0V3h13.5v11.25M5.25 14.25v3h13.5v-3M10.5 3v1.5m3 0V3" /></svg><span class="tooltip">ตรึงแนว</span></button>
                                        <button onclick="unfreezePanes()" class="icon-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h1.386q.512 0 .972.316.46.316.684.814L6.75 6.25m0 0l-1.5-1.5m1.5 1.5l1.5-1.5m-1.5 1.5V3m12 3.25l-1.5-1.5m1.5 1.5l1.5-1.5m-1.5 1.5V3m-3.75 3.25l-1.5-1.5m1.5 1.5l1.5-1.5m-1.5 1.5V3m-6 13.5V12h12.75v4.5m-12.75 0h12.75" /></svg><span class="tooltip">ยกเลิกการตรึง</span></button>
                                    </div>
                                    <div class="w-px h-6 bg-gray-300 mx-1"></div>
                                    <div id="export-controls" class="flex items-center gap-2">
                                        <span class="font-medium text-sm text-gray-600">ส่งออกเป็น:</span>
                                        <div class="flex gap-2 flex-wrap">
                                            <button onclick="exportData('xlsx')" class="bg-green-600 text-white font-bold py-1.5 px-3 rounded-md hover:bg-green-700 transition-all text-sm">.xlsx</button>
                                            <button onclick="exportData('xls')" class="bg-blue-600 text-white font-bold py-1.5 px-3 rounded-md hover:bg-blue-700 transition-all text-sm">.xls</button>
                                            <button onclick="exportData('csv')" class="bg-gray-600 text-white font-bold py-1.5 px-3 rounded-md hover:bg-gray-700 transition-all text-sm">.csv</button>
                                        </div>
                                    </div>
                                    <div class="w-px h-6 bg-gray-300 mx-1"></div>
                                    <div class="flex items-center gap-1">
                                        <button onclick="zoomOut()" class="icon-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM13.5 10.5h-6" /></svg><span class="tooltip">ย่อ</span></button>
                                        <span id="zoom-display" class="font-bold w-16 text-center text-sm text-gray-700">100%</span>
                                        <button onclick="zoomIn()" class="icon-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM10.5 7.5v6m3-3h-6" /></svg><span class="tooltip">ขยาย</span></button>
                                    </div>
                                </div>
                            </div>

                             <div class="flex items-center gap-2 mb-2 p-2 bg-gray-50 rounded-lg border">
                                <span id="selected-cell-address" class="font-mono text-sm text-gray-500 w-16 text-center">A1</span>
                                <input type="text" id="formula-bar" class="w-full p-1 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            </div>
                             <!-- Sheet Tabs Container -->
                            <div id="sheet-selector-container" class="border-b border-gray-300 overflow-x-auto">
                                <div id="sheet-selector" class="flex flex-nowrap gap-1 -mb-px"></div>
                            </div>
                            <div id="table-container" tabindex="0"></div>
                            <!-- Table Status Bar -->
                            <div id="table-status-bar" class="text-sm text-gray-600 bg-gray-100 p-2 mt-1 rounded-b-lg text-right"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Global State ---
        let currentWorkbook = null;
        let currentFilename = 'edited_file';
        let activeSheetName = '';
        let copiedData = null;
        let copiedMerges = []; // Holds merge info for copy/paste
        let isSelecting = false;
        let $startCell = null;
        let currentZoom = 1.0;
        let selectedRows = new Set();
        let selectedCols = new Set();
        let actionHistory = [];
        let redoHistory = [];
        const HISTORY_LIMIT = 30;
        let sheetMerges = {};
        let lastSelectedRowIndex = -1;
        let lastSelectedColIndex = -1;
        let frozenState = { row: 0, col: 0 };
        let activeFilters = {};

        // --- Main Initialization ---
        $(document).ready(function() {
            initTabs();
            initDragAndDrop();
            initEditorInteractions();
            initGlobalListeners();
            loadHistory();
        });
        
        // --- Initialization Functions ---
        function initTabs() {
            $('#tab-btn-convert').on('click', () => switchTab('convert'));
            $('#tab-btn-edit').on('click', () => switchTab('edit'));
        }

        function initDragAndDrop() {
            // Helper for setting up drag and drop zones
            const setupZone = ($element, fileHandler) => {
                $element.on('dragover', (e) => {
                    e.preventDefault();
                    $element.addClass('drag-over');
                }).on('dragleave', () => $element.removeClass('drag-over'))
                .on('drop', (e) => {
                    e.preventDefault();
                    $element.removeClass('drag-over');
                    if (e.originalEvent.dataTransfer.files.length > 0) {
                        fileHandler(e.originalEvent.dataTransfer.files[0]);
                    }
                });
            };

            // Quick Convert Zone
            setupZone($('#drop-zone-convert'), handleFileConvert);
            $('#drop-zone-convert').on('click', () => $('#file-input-convert').trigger('click'));
            $('#file-input-convert').on('change', (e) => {
                if (e.target.files.length > 0) handleFileConvert(e.target.files[0]);
            });

            // Edit & Export Zone
            setupZone($('#drop-zone-edit'), handleFileEdit);
            $('#drop-zone-edit').on('click', () => $('#file-input-edit').trigger('click'));
            $('#file-input-edit').on('change', (e) => {
                if (e.target.files.length > 0) handleFileEdit(e.target.files[0]);
            });
            
            // Allow dropping files directly onto the editor view
            $('#editor-view').on('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                $('#table-container').css({'outline': '4px dashed #3b82f6', 'outline-offset': '-8px'});
            }).on('dragleave drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                $('#table-container').css({'outline': ''});
                if (e.type === 'drop' && e.originalEvent.dataTransfer.files.length > 0) {
                    resetEditor();
                    handleFileEdit(e.originalEvent.dataTransfer.files[0]);
                }
            });
        }

        function initEditorInteractions() {
            // History management
            $('#clear-history-btn').on('click', clearHistory);
            $('#history-list').on('click', '.delete-history-item-btn', function() {
                $(this).closest('li').data('date') && deleteHistoryItem($(this).closest('li').data('date'));
            });

            // Sheet tab switching
            $('#sheet-selector').on('click', '.sheet-tab', function() {
                const sheetName = $(this).data('sheetName');
                if (sheetName !== activeSheetName) {
                    updateSheetData();
                    renderSheet(sheetName);
                    saveState(false);
                }
            });
            
            // Formula bar logic
            $('#formula-bar').on('input', function() {
                if ($startCell && document.activeElement === this) {
                    $startCell.text($(this).val());
                }
            }).on('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if ($startCell) {
                        $startCell.text($(this).val());
                        saveState();
                        handleTableNavigation(e); // Move to next cell
                    }
                }
            });

            initTableSelectionAndEditing();
        }
        
        function initTableSelectionAndEditing() {
            const $tableContainer = $('#table-container');

            // Header/Row number selection
            $tableContainer.on('click', 'th', function(e) {
                const $th = $(this);
                if ($th.find('.filter-btn').length > 0 || $(e.target).closest('.filter-btn').length > 0) return;
                
                const isHeader = $th.parent().parent().is('thead');
                const isRowNumber = $th.parent().parent().is('tbody');

                if (isHeader || isRowNumber) {
                    handleHeaderSelection(e, $th, isHeader);
                }
            });

            // Cell selection (mousedown, mouseover, mouseup)
            $tableContainer.on('mousedown', 'td', function(e) {
                isSelecting = true;
                if (e.shiftKey && $startCell) {
                    updateCellSelection($(this));
                } else {
                    selectCell($(this));
                }
                e.preventDefault();
            });
            $tableContainer.on('mouseover', 'td', (e) => isSelecting && updateCellSelection($(e.currentTarget)));
            $(document).on('mouseup', () => isSelecting = false);

            // Cell editing (dblclick, focusout)
            $tableContainer.on('dblclick', 'td, thead th:not(:first-child)', function() {
                const $cell = $(this);
                if ($cell.find('.filter-btn').length > 0) return;
                if (!$cell.is('[contenteditable="true"]')) {
                    $cell.attr('contenteditable', 'true').focus();
                    // Place cursor at the end of the text
                    const sel = window.getSelection();
                    sel.selectAllChildren($cell[0]);
                    sel.collapseToEnd();
                }
            });
            $tableContainer.on('focusout', 'td, thead th', function() {
                if ($(this).is('[contenteditable="true"]')) {
                    $(this).removeAttr('contenteditable');
                    saveState();
                }
            });

            // Filter logic
            $tableContainer.on('click', '.filter-btn', openFilterDropdown);
        }

        function initGlobalListeners() {
            // Close filter dropdown when clicking outside
            $(document).on('click', (e) => {
                if (!$(e.target).closest('.filter-dropdown, .filter-btn').length) {
                    $('.filter-dropdown').remove();
                }
            });

            // Keyboard shortcuts
            $(document).on('keydown', handleGlobalKeyDown);

            // Recalculate sticky positions on resize
            $(window).on('resize', updateStickyHeaderPosition);
        }

        // --- Tab & File Handling ---
        function switchTab(tabName) {
            $('.tab-button, .tab-content').removeClass('active');
            $(`#tab-btn-${tabName}, #content-${tabName}`).addClass('active');
        }

        function handleFileConvert(file) {
            if (!file.name.toLowerCase().endsWith('.xlsx')) {
                return displayMessage('โปรดเลือกไฟล์ .xlsx เท่านั้น', 'error');
            }
            displayMessage('กำลังแปลงไฟล์...', 'loading');
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const workbook = XLSX.read(e.target.result, { type: 'binary' });
                    const newFileName = file.name.replace(/\.xlsx$/i, '.xls');
                    XLSX.writeFile(workbook, newFileName, { bookType: 'xls' });
                    displayMessage(`แปลงไฟล์ ${file.name} สำเร็จ!`, 'success');
                    addHistoryEntry(file.name, newFileName);
                } catch (error) {
                    displayMessage('เกิดข้อผิดพลาดระหว่างการแปลงไฟล์', 'error');
                }
            };
            reader.readAsBinaryString(file);
            $('#file-input-convert').val('');
        }
        
        function handleFileEdit(file) {
            const validExtensions = ['.xlsx', '.xls', '.csv'];
            if (!validExtensions.some(ext => file.name.toLowerCase().endsWith(ext))) {
                return Swal.fire('ข้อผิดพลาด', 'โปรดเลือกไฟล์ .xlsx, .xls หรือ .csv เท่านั้น', 'error');
            }
            currentFilename = file.name.split('.').slice(0, -1).join('.');
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    currentWorkbook = XLSX.read(e.target.result, { type: 'array', cellDates: true, bookVBA: true });
                    
                    // Reset editor state for new file
                    actionHistory = []; 
                    redoHistory = [];
                    sheetMerges = {}; 
                    frozenState = { row: 0, col: 0 }; 
                    activeFilters = {};

                    currentWorkbook.SheetNames.forEach(name => {
                        sheetMerges[name] = currentWorkbook.Sheets[name]['!merges'] || [];
                    });
                    
                    const $sheetSelector = $('#sheet-selector').empty();
                    currentWorkbook.SheetNames.forEach(name => {
                        $sheetSelector.append($('<button></button>').addClass('sheet-tab').text(name).data('sheetName', name));
                    });
                    
                    $('#drop-zone-edit').hide();
                    $('#editor-view').show();
                    renderSheet(currentWorkbook.SheetNames[0]);
                    saveState(false); // Save initial state
                    
                } catch (error) {
                    Swal.fire('ข้อผิดพลาด', 'ไม่สามารถอ่านไฟล์ได้ โปรดตรวจสอบว่าไฟล์ไม่เสียหาย', 'error');
                    console.error("File read error:", error);
                }
            };
            reader.readAsArrayBuffer(file);
            $('#file-input-edit').val('');
        }

        function resetEditor() {
            currentWorkbook = null;
            currentFilename = 'edited_file';
            activeSheetName = '';
            activeFilters = {};
            $('#table-container, #sheet-selector').empty();
            $('#table-status-bar').text('');
            $('#editor-view').hide();
            $('#drop-zone-edit').show();
            actionHistory = [];
            redoHistory = [];
            sheetMerges = {};
            unfreezePanes(false);
        }

        // --- Sheet & Table Rendering ---
        function updateSheetData() {
            if (!currentWorkbook || !activeSheetName) return;
            const $table = $('#excel-table');
            if (!$table.length) return;

            const data = [];
            const headerRow = $table.find('thead tr:first th').slice(1).map((i, th) => $(th).text()).get();
            data.push(headerRow);
            
            $table.find('tbody tr').each(function() {
                data.push($(this).find('td').map((i, td) => $(td).text()).get());
            });

            const sheet = XLSX.utils.aoa_to_sheet(data, {cellDates: true});
            sheet['!merges'] = sheetMerges[activeSheetName] || [];
            currentWorkbook.Sheets[activeSheetName] = sheet;
        }

        function renderSheet(sheetName) {
            if (!currentWorkbook || !currentWorkbook.Sheets[sheetName]) return;
            
            activeSheetName = sheetName;
            unfreezePanes(false);
            clearAllSelections();
            
            $('.sheet-tab').removeClass('active').filter(`[data-sheet-name="${sheetName}"]`).addClass('active');

            const sheet = currentWorkbook.Sheets[sheetName];
            sheetMerges[activeSheetName] = sheetMerges[activeSheetName] || sheet['!merges'] || [];
            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
            
            let maxCols = jsonData.reduce((max, row) => Math.max(max, row.length), 0);
            if (jsonData.length === 0) {
                maxCols = 12; 
                for(let i = 0; i < 21; i++) jsonData.push(new Array(maxCols).fill(''));
            } else if (maxCols === 0) {
                maxCols = 1;
            }

            const headers = jsonData[0] || [];
            const headerHTML = Array.from({ length: maxCols }, (_, i) => `<th>${headers[i] || XLSX.utils.encode_col(i)}</th>`).join('');
            const filterHTML = Array.from({ length: maxCols }, (_, i) => `
                <th>
                    <div class="relative flex justify-center items-center">
                        <button class="filter-btn p-1 rounded hover:bg-gray-200 ${activeFilters[i] ? 'active' : ''}" data-col-index="${i}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2a1 1 0 01-.293.707L16 11.414V16a1 1 0 01-1 1l-3-2a1 1 0 01-.5-.828V11.414L4.293 6.707A1 1 0 014 6V4z" /></svg>
                        </button>
                    </div>
                </th>`).join('');

            let bodyHTML = '';
            for (let r = 1; r < jsonData.length; r++) {
                bodyHTML += `<tr><th>${r}</th>`;
                for (let c = 0; c < maxCols; c++) {
                    bodyHTML += `<td data-r="${r-1}" data-c="${c}">${jsonData[r]?.[c] ?? ''}</td>`;
                }
                bodyHTML += `</tr>`;
            }
            
            const tableHTML = `
                <table id="excel-table">
                    <thead>
                        <tr><th></th>${headerHTML}</tr>
                        <tr class="filter-row"><th></th>${filterHTML}</tr>
                    </thead>
                    <tbody>${bodyHTML}</tbody>
                </table>`;
            
            $('#table-container').html(tableHTML);
            
            applyMerges();
            applyZoom(true); // This also calls updateStickyHeaderPosition
            filterTable();
            updateRowCount();
        }

        function applyMerges() {
            (sheetMerges[activeSheetName] || []).forEach(merge => {
                const { s, e } = merge; // start, end
                const $topCell = $(`td[data-r="${s.r}"][data-c="${s.c}"]`);
                if ($topCell.length) {
                    $topCell.attr('colSpan', e.c - s.c + 1).attr('rowSpan', e.r - s.r + 1);
                    for (let r = s.r; r <= e.r; r++) {
                        for (let c = s.c; c <= e.c; c++) {
                            if (r !== s.r || c !== s.c) {
                                $(`td[data-r="${r}"][data-c="${c}"]`).hide();
                            }
                        }
                    }
                }
            });
        }

        function updateStickyHeaderPosition() {
            requestAnimationFrame(() => {
                const $table = $('#excel-table');
                if (!$table.length) return;
                const $headerRow = $table.find('thead tr:first-child');
                if ($headerRow.length && $headerRow[0]) {
                    // Get the precise height of the header row.
                    const headerHeight = $headerRow[0].getBoundingClientRect().height;
                    // Set the filter row's top position. Subtracting 1px helps prevent
                    // rendering gaps that can appear at certain browser zoom levels
                    // due to sub-pixel rounding.
                    $table.find('thead .filter-row th').css('top', `${headerHeight - 3}px`);
                }
            });
        }


        // --- Filter Logic ---
        function openFilterDropdown(e) {
            e.stopPropagation();
            $('.filter-dropdown').remove();

            const $btn = $(e.currentTarget);
            const colIndex = $btn.data('col-index');
            
            const uniqueValues = new Set();
            // *** FIX: Get values from ALL rows, not just visible ones, to prevent items from disappearing from the filter list. ***
            $('#excel-table tbody tr').each(function() {
                uniqueValues.add($(this).find(`td`).eq(colIndex).text().trim());
            });

            const sortedValues = [...uniqueValues].sort((a,b) => a.localeCompare(b, undefined, {numeric: true}));
            const currentFilter = activeFilters[colIndex];

            const listItems = sortedValues.map(value => {
                const isChecked = currentFilter === undefined || currentFilter.has(value);
                const displayValue = value === '' ? '(ค่าว่าง)' : value;
                return `
                    <label class="filter-item">
                        <input type="checkbox" class="filter-value-checkbox" value="${String(value).replace(/"/g, '&quot;')}" ${isChecked ? 'checked' : ''}>
                        <span>${displayValue}</span>
                    </label>`;
            }).join('');

            const dropdownHTML = `
                <div class="filter-dropdown">
                    <div class="p-2 border-b"><input type="text" class="w-full p-1 border rounded" placeholder="ค้นหาค่า..."></div>
                    <div class="flex justify-between p-2">
                         <button class="text-xs text-blue-600 hover:underline" id="filter-select-all">เลือกทั้งหมด</button>
                         <button class="text-xs text-blue-600 hover:underline" id="filter-clear-all">ล้างการเลือก</button>
                    </div>
                    <div class="filter-values-list">${listItems}</div>
                    <div class="p-2 border-t flex justify-end gap-2">
                        <button id="filter-apply-btn" class="bg-blue-600 text-white text-sm font-bold py-1 px-3 rounded hover:bg-blue-700">ปรับใช้</button>
                        <button id="filter-cancel-btn" class="bg-gray-200 text-sm font-bold py-1 px-3 rounded hover:bg-gray-300">ยกเลิก</button>
                    </div>
                </div>`;
            
            const $dropdown = $(dropdownHTML).appendTo('body').css({
                top: $btn.offset().top + $btn.outerHeight(),
                left: $btn.offset().left
            }).on('click', e => e.stopPropagation());

            $dropdown.find('input[type="text"]').on('input', function() {
                const term = $(this).val().toLowerCase();
                $dropdown.find('.filter-item').toggle(function() {
                    return $(this).text().toLowerCase().includes(term);
                });
            });
            
            $dropdown.find('#filter-select-all').on('click', () => $dropdown.find('.filter-item:visible .filter-value-checkbox').prop('checked', true));
            $dropdown.find('#filter-clear-all').on('click', () => $dropdown.find('.filter-item:visible .filter-value-checkbox').prop('checked', false));
            $dropdown.find('#filter-cancel-btn').on('click', () => $dropdown.remove());
            $dropdown.find('#filter-apply-btn').on('click', () => {
                applyColumnFilter(colIndex);
                $dropdown.remove();
            });
        }

        function applyColumnFilter(colIndex) {
            const selectedValues = new Set($('.filter-dropdown .filter-value-checkbox:checked').map((i, el) => $(el).val()).get());
            const allValues = new Set($('.filter-dropdown .filter-value-checkbox').map((i, el) => $(el).val()).get());

            // *** FIX: Restore logic to clear the filter if all items are selected. ***
            if (selectedValues.size === allValues.size) {
                delete activeFilters[colIndex];
            } else {
                activeFilters[colIndex] = selectedValues;
            }
            filterTable();
            $(`.filter-btn[data-col-index="${colIndex}"]`).toggleClass('active', !!activeFilters[colIndex]);
        }
        
        function filterTable() {
            const $rows = $('#excel-table tbody tr');
            if (Object.keys(activeFilters).length === 0) {
                return $rows.show() && updateRowCount();
            }

            $rows.each(function() {
                const $row = $(this);
                const isVisible = Object.entries(activeFilters).every(([colIndex, filterValues]) => {
                    const cellValue = $row.find('td').eq(parseInt(colIndex)).text().trim();
                    return filterValues.has(cellValue);
                });
                $row.toggle(isVisible);
            });
            updateRowCount();
        }

        // --- Data Export (MODIFIED) ---
        function exportData(format) {
            if (!activeSheetName) return Swal.fire('ข้อผิดพลาด', "ไม่มีชีตที่กำลังทำงานอยู่เพื่อส่งออก", 'error');
            displayMessage('กำลังสร้างไฟล์...', 'loading');

            try {
                // First, ensure the main workbook object is up-to-date with any changes in the DOM.
                // This is crucial for other sheets and for the case where there are no filters.
                updateSheetData();

                const fileName = `${currentFilename}_edited.${format}`;
                let workbookToExport = currentWorkbook;

                // If there are active filters on the current sheet, create a new workbook
                // with a filtered version of the active sheet.
                if (Object.keys(activeFilters).length > 0) {
                    console.log("ส่งออกโดยใช้ตัวกรอง / Exporting with active filters.");
                    const $table = $('#excel-table');
                    const $visibleRows = $table.find('tbody tr:visible');

                    // 1. Get headers and visible data
                    const exportDataAOA = [];
                    const headerRow = $table.find('thead tr:first th').slice(1).map((i, th) => $(th).text()).get();
                    exportDataAOA.push(headerRow);

                    const oldToNewRowMap = {};
                    let newRowIdx = 1; // 0 is the header row

                    $visibleRows.each(function() {
                        const $row = $(this);
                        // The original data row index (0-based) is stored in the first td's data-r attribute
                        const originalDataRowIndex = $row.find('td:first').data('r');
                        if (originalDataRowIndex !== undefined) {
                            // Map the original data row index to the new 0-based data row index for the export
                            oldToNewRowMap[originalDataRowIndex] = newRowIdx - 1;
                        }
                        exportDataAOA.push($row.find('td').map((i, td) => $(td).text()).get());
                        newRowIdx++;
                    });

                    // 2. Remap merges for the visible rows
                    const newMerges = [];
                    (sheetMerges[activeSheetName] || []).forEach(merge => {
                        // Check if the starting row of the merge is visible
                        if (oldToNewRowMap.hasOwnProperty(merge.s.r)) {
                            const newStartRow = oldToNewRowMap[merge.s.r];
                            // Check if the ending row is also visible to include the merge
                            const newEndRow = oldToNewRowMap[merge.e.r];
                            
                            if (newEndRow !== undefined) {
                                 newMerges.push({
                                    s: { r: newStartRow, c: merge.s.c },
                                    e: { r: newEndRow, c: merge.e.c }
                                });
                            }
                        }
                    });
                    
                    // 3. Create a new sheet with filtered data and remapped merges
                    const newSheet = XLSX.utils.aoa_to_sheet(exportDataAOA, { cellDates: true });
                    newSheet['!merges'] = newMerges;
                    
                    // 4. Create a new workbook and copy over all sheets, replacing the active one
                    const newWorkbook = XLSX.utils.book_new();
                    currentWorkbook.SheetNames.forEach(name => {
                        const sheetToAppend = (name === activeSheetName) ? newSheet : currentWorkbook.Sheets[name];
                        XLSX.utils.book_append_sheet(newWorkbook, sheetToAppend, name);
                    });
                    workbookToExport = newWorkbook;
                }

                // 5. Write the final workbook (either original or the new filtered one)
                XLSX.writeFile(workbookToExport, fileName, { bookType: format, cellDates: true });
                displayMessage(`สร้างไฟล์ ${fileName} สำเร็จ!`, 'success');

            } catch (error) {
                displayMessage('เกิดข้อผิดพลาดในการสร้างไฟล์', 'error');
                console.error("Export error:", error);
            }
        }

        // --- History (Undo/Redo) ---
        function saveState(shouldUpdateFromDOM = true) {
            if (!currentWorkbook) return;
            if (shouldUpdateFromDOM && activeSheetName) updateSheetData();
            
            const state = {
                sheets: {},
                merges: JSON.parse(JSON.stringify(sheetMerges)),
                activeSheet: activeSheetName,
                frozen: {...frozenState},
                filters: JSON.parse(JSON.stringify(activeFilters, (k, v) => v instanceof Set ? [...v] : v))
            };
            currentWorkbook.SheetNames.forEach(name => {
                 state.sheets[name] = XLSX.utils.sheet_to_json(currentWorkbook.Sheets[name], { header: 1, defval: '' });
            });
            
            actionHistory.push(state);
            redoHistory = [];
            if (actionHistory.length > HISTORY_LIMIT) actionHistory.shift();
        }

        function restoreState(state) {
            if (!state) return;
            const newWorkbook = XLSX.utils.book_new();
            Object.keys(state.sheets).forEach(sheetName => {
                const newSheet = XLSX.utils.aoa_to_sheet(state.sheets[sheetName]);
                newSheet['!merges'] = state.merges[sheetName] || [];
                XLSX.utils.book_append_sheet(newWorkbook, newSheet, sheetName);
            });
            currentWorkbook = newWorkbook;
            sheetMerges = JSON.parse(JSON.stringify(state.merges));
            frozenState = state.frozen;
            activeFilters = JSON.parse(JSON.stringify(state.filters || {}), (k, v) => Array.isArray(v) ? new Set(v) : v);

            const $sheetSelector = $('#sheet-selector').empty();
            currentWorkbook.SheetNames.forEach(name => {
                $sheetSelector.append($('<button class="sheet-tab"></button>').text(name).data('sheetName', name));
            });
            renderSheet(state.activeSheet);
        }

        function undo() {
            if (actionHistory.length <= 1) return displayMessage('ไม่มีการกระทำที่จะย้อนกลับ', 'info');
            redoHistory.push(actionHistory.pop());
            restoreState(actionHistory[actionHistory.length - 1]);
            displayMessage('ย้อนกลับการกระทำล่าสุด', 'success');
        }

        function redo() {
            if (redoHistory.length === 0) return displayMessage('ไม่มีการกระทำที่จะทำซ้ำ', 'info');
            const nextState = redoHistory.pop();
            actionHistory.push(nextState);
            restoreState(nextState);
            displayMessage('ทำซ้ำการกระทำ', 'success');
        }

        // --- Table Data Manipulation ---
        function performDataOperation(operation) {
            updateSheetData();
            operation(); // Execute data modification
            renderSheet(activeSheetName);
            saveState(false);
        }

        function insertRow(direction) {
            performDataOperation(() => {
                let data = XLSX.utils.sheet_to_json(currentWorkbook.Sheets[activeSheetName], {header: 1, defval: ''});
                let insertAt; 
                
                if (selectedRows.size > 0) {
                    if (direction === 'above') {
                        insertAt = Math.min(...selectedRows);
                    } else { 
                        insertAt = Math.max(...selectedRows) + 1;
                    }
                } else if ($startCell) {
                    const cellDomRowIndex = $startCell.parent()[0].rowIndex;
                    insertAt = direction === 'above' ? cellDomRowIndex : cellDomRowIndex + 1;
                } else {
                    insertAt = direction === 'above' ? 2 : data.length + 1;
                }
                
                insertAt = Math.max(2, insertAt);
                const dataSpliceIndex = insertAt - 1;

                data.splice(dataSpliceIndex, 0, Array((data[0] || []).length).fill(''));
                
                // *** FIX: Adjust merge info for inserted row ***
                const dataRowIndex = dataSpliceIndex - 1; // 0-based index for merges
                (sheetMerges[activeSheetName] || []).forEach(merge => {
                    if (merge.s.r >= dataRowIndex) {
                        merge.s.r++;
                        merge.e.r++;
                    } else if (merge.e.r >= dataRowIndex) {
                        merge.e.r++;
                    }
                });

                const newSheet = XLSX.utils.aoa_to_sheet(data);
                newSheet['!merges'] = sheetMerges[activeSheetName];
                currentWorkbook.Sheets[activeSheetName] = newSheet;
                displayMessage(`แทรกแถว${direction === 'above' ? 'ด้านบน' : 'ด้านล่าง'}แล้ว`, 'success');
            });
        }

        function insertColumn(direction) {
            performDataOperation(() => {
                let data = XLSX.utils.sheet_to_json(currentWorkbook.Sheets[activeSheetName], {header: 1, defval: ''});
                let insertAt; // This will be the 0-based data column index
                if (selectedCols.size > 0) {
                    insertAt = direction === 'left' ? Math.min(...selectedCols) - 1 : Math.max(...selectedCols);
                } else if ($startCell) {
                    const startCol = $startCell.data('c');
                    insertAt = direction === 'left' ? startCol : startCol + 1;
                } else {
                    insertAt = direction === 'left' ? 0 : (data[0] || []).length;
                }

                data.forEach(row => row.splice(insertAt, 0, ''));

                // *** FIX: Adjust merge info for inserted column ***
                (sheetMerges[activeSheetName] || []).forEach(merge => {
                    if (merge.s.c >= insertAt) {
                        merge.s.c++;
                        merge.e.c++;
                    } else if (merge.e.c >= insertAt) {
                        merge.e.c++;
                    }
                });
                
                // *** FIX: Adjust active filters for inserted column ***
                const newFilters = {};
                for (const col in activeFilters) {
                    const colIndex = parseInt(col);
                    if (colIndex >= insertAt) {
                        newFilters[colIndex + 1] = activeFilters[col];
                    } else {
                        newFilters[colIndex] = activeFilters[col];
                    }
                }
                activeFilters = newFilters;

                const newSheet = XLSX.utils.aoa_to_sheet(data);
                newSheet['!merges'] = sheetMerges[activeSheetName];
                currentWorkbook.Sheets[activeSheetName] = newSheet;
                displayMessage(`แทรกคอลัมน์${direction === 'left' ? 'ซ้าย' : 'ขวา'}แล้ว`, 'success');
            });
        }

        function deleteSelectedRows() {
            if (selectedRows.size === 0) return Swal.fire('คำเตือน', 'โปรดเลือกแถวที่ต้องการลบ', 'warning');
            performDataOperation(() => {
                let data = XLSX.utils.sheet_to_json(currentWorkbook.Sheets[activeSheetName], {header: 1, defval: ''});
                const indicesToDelete = [...selectedRows].map(r => r - 1).sort((a, b) => b - a); // Convert to 1-based data index, sort descending
                
                indicesToDelete.forEach(index => data.splice(index, 1));

                // *** FIX: Adjust merge info for deleted rows ***
                const deletedDataRowIndices = indicesToDelete.map(i => i - 1).sort((a,b) => b-a); // 0-based
                deletedDataRowIndices.forEach(deletedIndex => {
                    sheetMerges[activeSheetName] = (sheetMerges[activeSheetName] || []).filter(m => m.s.r !== deletedIndex || m.e.r !== deletedIndex);
                    (sheetMerges[activeSheetName] || []).forEach(merge => {
                        if (merge.s.r > deletedIndex) {
                            merge.s.r--;
                            merge.e.r--;
                        } else if (merge.e.r >= deletedIndex) {
                            merge.e.r--;
                        }
                    });
                });

                const newSheet = XLSX.utils.aoa_to_sheet(data);
                newSheet['!merges'] = sheetMerges[activeSheetName];
                currentWorkbook.Sheets[activeSheetName] = newSheet;
                displayMessage('ลบแถวที่เลือกแล้ว', 'success');
            });
        }

        function deleteSelectedColumns() {
            if (selectedCols.size === 0) return Swal.fire('คำเตือน', 'โปรดเลือกคอลัมน์ที่ต้องการลบ', 'warning');
            performDataOperation(() => {
                let data = XLSX.utils.sheet_to_json(currentWorkbook.Sheets[activeSheetName], {header: 1, defval: ''});
                const indicesToDelete = [...selectedCols].map(c => c - 1).sort((a, b) => b - a); // 0-based data index
                
                data.forEach(row => indicesToDelete.forEach(index => row.splice(index, 1)));

                // *** FIX: Adjust merge info for deleted columns ***
                indicesToDelete.forEach(deletedIndex => {
                    sheetMerges[activeSheetName] = (sheetMerges[activeSheetName] || []).filter(m => m.s.c !== deletedIndex || m.e.c !== deletedIndex);
                     (sheetMerges[activeSheetName] || []).forEach(merge => {
                        if (merge.s.c > deletedIndex) {
                            merge.s.c--;
                            merge.e.c--;
                        } else if (merge.e.c >= deletedIndex) {
                            merge.e.c--;
                        }
                    });
                });
                
                // *** FIX: Adjust active filters for deleted columns ***
                indicesToDelete.forEach(deletedIndex => {
                    delete activeFilters[deletedIndex];
                    const newFilters = {};
                    for (const col in activeFilters) {
                        const colIndex = parseInt(col);
                        if (colIndex > deletedIndex) {
                            newFilters[colIndex - 1] = activeFilters[col];
                        } else {
                            newFilters[colIndex] = activeFilters[col];
                        }
                    }
                    activeFilters = newFilters;
                });

                const newSheet = XLSX.utils.aoa_to_sheet(data);
                newSheet['!merges'] = sheetMerges[activeSheetName];
                currentWorkbook.Sheets[activeSheetName] = newSheet;
                displayMessage('ลบคอลัมน์ที่เลือกแล้ว', 'success');
            });
        }
        
        function clearSelectedContent() {
            const $selectedCells = $('#excel-table td.selected');
            if ($selectedCells.length === 0) return displayMessage('โปรดเลือกช่องที่ต้องการลบข้อความ', 'info');
            $selectedCells.text('');
            saveState();
            displayMessage('ลบเนื้อหาแล้ว', 'success');
        }

        function mergeSelectedCells() {
            const $selectedCells = $('#excel-table td.selected');
            if ($selectedCells.length < 2) return Swal.fire('คำเตือน', 'โปรดเลือกอย่างน้อย 2 ช่องเพื่อผสาน', 'warning');
            performDataOperation(() => {
                let minR = Infinity, maxR = -Infinity, minC = Infinity, maxC = -Infinity;
                $selectedCells.each(function() {
                    minR = Math.min(minR, $(this).data('r')); maxR = Math.max(maxR, $(this).data('r'));
                    minC = Math.min(minC, $(this).data('c')); maxC = Math.max(maxC, $(this).data('c'));
                });
                sheetMerges[activeSheetName].push({ s: { r: minR, c: minC }, e: { r: maxR, c: maxC } });
                displayMessage('ผสานเซลล์แล้ว', 'success');
            });
        }

        function unmergeSelectedCells() {
            if(!$startCell) return Swal.fire('คำเตือน', 'โปรดเลือกช่องที่ถูกผสานไว้', 'warning');
            performDataOperation(() => {
                const r = $startCell.data('r'), c = $startCell.data('c');
                const mergeIndex = (sheetMerges[activeSheetName] || []).findIndex(m => r >= m.s.r && r <= m.e.r && c >= m.s.c && c <= m.e.c);
                if (mergeIndex > -1) {
                    sheetMerges[activeSheetName].splice(mergeIndex, 1);
                    displayMessage('ยกเลิกการผสานเซลล์แล้ว', 'success');
                } else {
                     Swal.fire('คำเตือน', 'ช่องที่เลือกไม่ได้ถูกผสานไว้', 'warning');
                }
            });
        }

        // --- Zoom & Freeze ---
        function zoomIn() { currentZoom < 2.0 && (currentZoom = Math.round((currentZoom + 0.1) * 10) / 10, applyZoom()); }
        function zoomOut() { currentZoom > 0.5 && (currentZoom = Math.round((currentZoom - 0.1) * 10) / 10, applyZoom()); }
        
        function applyZoom(reset = false) {
            if (reset) currentZoom = 1.0;
            const $table = $('#excel-table');
            if (!$table.length) return;
            $table.find('th, td').css({
                'font-size': `${0.875 * currentZoom}rem`,
                'padding': `${0.5 * currentZoom}rem`
            });
            $('#zoom-display').text(`${Math.round(currentZoom * 100)}%`);
            updateStickyHeaderPosition();
            applyFreezing(); // Re-apply freezing after zoom
        }

        function freezePanes() {
            let freezeRowIndex = 0; // The index of the first NON-FROZEN row
            let freezeColIndex = 0; // The index of the first NON-FROZEN column

            // If entire rows or columns are selected, freeze up to the max selected.
            if (selectedRows.size > 0 || selectedCols.size > 0) {
                if (selectedRows.size > 0) {
                    // Freeze up to and including the last selected row.
                    // The loop in applyFreezing is `i < frozenState.row`, so we need to provide the index of the first unfrozen row.
                    freezeRowIndex = Math.max(...selectedRows) + 1;
                }
                if (selectedCols.size > 0) {
                    // Freeze up to and including the last selected column.
                    freezeColIndex = Math.max(...selectedCols) + 1;
                }
            }
            // Otherwise, use the standard "freeze above and to the left of the active cell" behavior.
            else if ($startCell) {
                freezeRowIndex = $startCell.parent()[0].rowIndex;
                freezeColIndex = $startCell[0].cellIndex;
            }
            // If nothing is selected at all.
            else {
                return displayMessage('โปรดเลือกเซลล์, แถว, หรือคอลัมน์เพื่อเป็นจุดตรึงแนว', 'info');
            }

            frozenState = { row: freezeRowIndex, col: freezeColIndex };

            applyFreezing();
            saveState();
            displayMessage('ตรึงแนวที่เลือกแล้ว', 'success');
        }

        function unfreezePanes(showToast = true) {
            if (frozenState.row === 0 && frozenState.col === 0) return;
            frozenState = { row: 0, col: 0 };
            applyFreezing();
            if(showToast) {
                saveState();
                displayMessage('ยกเลิกการตรึงแนวแล้ว', 'success');
            }
        }

        function applyFreezing() {
            const $table = $('#excel-table');
            if (!$table.length) return;

            // 1. Clear all previous custom freezing styles from the entire table.
            $table.find('.frozen-row, .frozen-col, .frozen-corner').removeClass('frozen-row frozen-col frozen-corner');
            $table.find('th, td').each(function() {
                // Only remove inline styles we might have added, respecting thead stickiness
                if (!$(this).parent().parent().is('thead')) {
                    this.style.top = '';
                }
                if (!$(this).is('th:first-child')) {
                     this.style.left = '';
                }
            });

            // 2. IMPORTANT: Re-apply the base sticky behavior for the two header rows.
            updateStickyHeaderPosition();

            // 3. Exit if there's nothing to freeze beyond the default headers.
            if (frozenState.row <= 2 && frozenState.col <= 1) return;

            // 4. Defer for measurements.
            setTimeout(() => {
                const $allRows = $table.find('tr');
                if ($allRows.length === 0) return;

                // 5. Calculate offsets
                const colWidths = $allRows.first().find('th, td').map((i, c) => $(c).outerWidth()).get();
                const rowHeights = $allRows.map((i, r) => $(r).outerHeight()).get();
                
                let colOffsets = [0];
                for (let i = 1; i < colWidths.length; i++) colOffsets[i] = colOffsets[i-1] + colWidths[i-1];
                
                let rowOffsets = [0];
                for (let i = 1; i < rowHeights.length; i++) rowOffsets[i] = rowOffsets[i-1] + rowHeights[i-1];

                // 6. Freeze Columns (from col 1 up to frozenState.col)
                for (let j = 1; j < frozenState.col; j++) {
                    const leftOffset = colOffsets[j];
                    $allRows.find(`> *:nth-child(${j + 1})`).addClass('frozen-col').css('left', `${leftOffset}px`);
                }

                // 7. Freeze Rows (from row 2 up to frozenState.row)
                for (let i = 2; i < frozenState.row; i++) {
                    const topOffset = rowOffsets[i];
                    $allRows.eq(i).find('th, td').addClass('frozen-row').css('top', `${topOffset}px`);
                }
                
                // 8. Apply corner style to make sure it's on top
                for (let i = 0; i < frozenState.row; i++) {
                    for (let j = 0; j < frozenState.col; j++) {
                        $allRows.eq(i).find(`> *:nth-child(${j + 1})`).addClass('frozen-corner');
                    }
                }
            }, 50);
        }


        // --- Selection & Navigation ---
        function handleGlobalKeyDown(e) {
            const $activeEl = $(document.activeElement);
            // If user is already typing in an input, formula bar, or an editable cell, do nothing here.
            if ($activeEl.is('input:not(#formula-bar), textarea') || $activeEl.is('[contenteditable]')) {
                if (e.key === 'Enter' && !e.shiftKey && $activeEl.is('[contenteditable]')) {
                     e.preventDefault();
                     $activeEl.trigger('blur');
                     handleTableNavigation(e);
                }
                return;
            }
            if ($('#editor-view').is(':hidden')) return;
            
            if ((e.ctrlKey || e.metaKey) && !e.altKey) {
                const keyMap = { 'KeyC': copySelectedData, 'KeyV': pasteData, 'KeyZ': undo, 'KeyY': redo };
                if (keyMap[e.code]) {
                    e.preventDefault();
                    keyMap[e.code]();
                }
            } else if (e.code === 'Delete' || e.code === 'Backspace') {
                e.preventDefault();
                clearSelectedContent();
            } else if (e.key === 'F2') {
                 e.preventDefault();
                 if($startCell) $startCell.trigger('dblclick');
            // *** NEW FEATURE: START EDITING ON KEY PRESS ***
            // This checks if a printable character is pressed (key length is 1),
            // no modifier keys are active, and a cell is actually selected.
            } else if (e.key.length === 1 && !e.ctrlKey && !e.metaKey && !e.altKey && $startCell) {
                e.preventDefault(); // Prevent the key from doing anything else
                // Make the cell editable, clear its content, and insert the pressed key
                $startCell.attr('contenteditable', 'true').text(e.key).focus();
                
                // This is a small trick to move the cursor to the end of the new content
                const selection = window.getSelection();
                selection.selectAllChildren($startCell[0]);
                selection.collapseToEnd();
            } else {
                // If none of the above, handle navigation (arrow keys, tab, enter)
                handleTableNavigation(e);
            }
        }
        
        function handleTableNavigation(e) {
            if (!$startCell || !['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Enter', 'Tab'].includes(e.key)) return;
            e.preventDefault(); 

            let r = $startCell.parent()[0].rowIndex, c = $startCell[0].cellIndex;
            const maxR = $('#excel-table tr').length - 1, maxC = $('#excel-table tr:first th').length - 1;

            switch(e.key) {
                case 'ArrowUp': r = Math.max(2, r - 1); break;
                case 'ArrowDown': r = Math.min(maxR, r + 1); break;
                case 'ArrowLeft': c = Math.max(1, c - 1); break;
                case 'ArrowRight': c = Math.min(maxC, c + 1); break;
                case 'Enter': r = e.shiftKey ? Math.max(2, r - 1) : Math.min(maxR, r + 1); break;
                case 'Tab':
                    if (e.shiftKey) { [c, r] = c > 1 ? [c - 1, r] : r > 2 ? [maxC, r - 1] : [c, r]; } 
                    else { [c, r] = c < maxC ? [c + 1, r] : r < maxR ? [1, r + 1] : [c, r]; }
                    break;
            }
            const $newCell = $(`#excel-table tr:eq(${r})`).find('td, th').eq(c);
            if ($newCell.length) selectCell($newCell); 
        }

        function handleHeaderSelection(e, $th, isHeaderClick) {
            const isCtrl = e.ctrlKey || e.metaKey;
            const isShift = e.shiftKey;
            if (!isCtrl && !isShift) clearAllSelections();

            if (isHeaderClick) {
                const colIndex = $th[0].cellIndex;
                if (colIndex === 0) return;
                if (isShift && lastSelectedColIndex > 0) {
                    const [start, end] = [Math.min(lastSelectedColIndex, colIndex), Math.max(lastSelectedColIndex, colIndex)];
                    for (let i = start; i <= end; i++) selectedCols.add(i);
                } else {
                    selectedCols.has(colIndex) && isCtrl ? selectedCols.delete(colIndex) : selectedCols.add(colIndex);
                    lastSelectedColIndex = colIndex;
                }
                lastSelectedRowIndex = -1;
            } else { // Row number click
                const rowIndex = $th.parent()[0].rowIndex;
                if (isShift && lastSelectedRowIndex > 0) {
                    const [start, end] = [Math.min(lastSelectedRowIndex, rowIndex), Math.max(lastSelectedRowIndex, rowIndex)];
                    for (let i = start; i <= end; i++) selectedRows.add(i);
                } else {
                    selectedRows.has(rowIndex) && isCtrl ? selectedRows.delete(rowIndex) : selectedRows.add(rowIndex);
                    lastSelectedRowIndex = rowIndex;
                }
                lastSelectedColIndex = -1;
            }
            updateVisualSelection();
        }

        function clearAllSelections() {
            $('.selected, .selected-header').removeClass('selected selected-header');
            selectedRows.clear();
            selectedCols.clear();
            $startCell = null;
            lastSelectedRowIndex = -1;
            lastSelectedColIndex = -1;
        }
        
        function selectCell($cell, clearPrevious = true) {
            if (!$cell || !$cell.is('td')) return;
            if (clearPrevious) clearAllSelections();
            
            $cell.addClass('selected');
            $startCell = $cell; 
            updateFormulaBar($cell);
            
            $cell[0].scrollIntoView({ block: 'nearest', inline: 'nearest' });
            $('#table-container').focus();
        }
        
        function updateVisualSelection() {
            $('.selected, .selected-header').removeClass('selected selected-header');
            const $table = $('#excel-table');
            if (!$table.length) return;
            selectedRows.forEach(r => {
                const $row = $table.find('tr').eq(r);
                $row.find('th:first-child').addClass('selected-header');
                $row.find('td').addClass('selected');
            });
            selectedCols.forEach(c => {
                $table.find('tr').each(function() {
                    const $cell = $(this).find('th, td').eq(c);
                    $(this).parent().is('thead') ? $cell.addClass('selected-header') : $cell.addClass('selected');
                });
            });
        }
        
        function updateFormulaBar($cell) {
            if (!$cell || !$cell.length) {
                $('#formula-bar').val('');
                $('#selected-cell-address').text('');
                return;
            }
            $('#formula-bar').val($cell.text());
            const colName = $('#excel-table thead tr:first').find('th').eq($cell[0].cellIndex).text();
            const rowName = $cell.parent().find('th:first').text();
            $('#selected-cell-address').text(colName + rowName);
        }

        function updateCellSelection($endCell) {
            $('#excel-table td.selected').removeClass('selected');
            const [startR, startC] = [$startCell.parent()[0].rowIndex, $startCell[0].cellIndex];
            const [endR, endC] = [$endCell.parent()[0].rowIndex, $endCell[0].cellIndex];
            const [minR, maxR] = [Math.min(startR, endR), Math.max(startR, endR)];
            const [minC, maxC] = [Math.min(startC, endC), Math.max(startC, endC)];

            for (let i = minR; i <= maxR; i++) {
                for (let j = minC; j <= maxC; j++) {
                    $(`#excel-table tr:eq(${i}) td:eq(${j-1})`).addClass('selected');
                }
            }
        }
        
        // --- Clipboard (Copy/Paste) ---
        function copySelectedData() {
            const $selected = $('#excel-table td.selected');
            if ($selected.length === 0) return displayMessage('ไม่มีช่องที่เลือกเพื่อคัดลอก', 'info');
            
            copiedMerges = []; // Reset merges on new copy

            let minR = Infinity, maxR = -Infinity, minC = Infinity, maxC = -Infinity;
            $selected.each(function() {
                const r = $(this).data('r');
                const c = $(this).data('c');
                minR = Math.min(minR, r); maxR = Math.max(maxR, r);
                minC = Math.min(minC, c); maxC = Math.max(maxC, c);
            });

            // Find and store relative merges within the selection
            (sheetMerges[activeSheetName] || []).forEach(merge => {
                if (merge.s.r >= minR && merge.s.r <= maxR && merge.s.c >= minC && merge.s.c <= maxC) {
                    copiedMerges.push({
                        s: { r: merge.s.r - minR, c: merge.s.c - minC },
                        e: { r: merge.e.r - minR, c: merge.e.c - minC }
                    });
                }
            });

            const data = [];
            for (let r = minR; r <= maxR; r++) {
                const row = [];
                for (let c = minC; c <= maxC; c++) {
                    const $cell = $(`td[data-r="${r}"][data-c="${c}"]`);
                    row.push($cell.text());
                }
                data.push(row);
            }
            copiedData = data;
            const tsv = data.map(row => row.join('\t')).join('\n');
            navigator.clipboard.writeText(tsv)
                .then(() => displayMessage('คัดลอกข้อมูลแล้ว', 'success'))
                .catch(() => displayMessage('คัดลอกข้อมูลแล้ว (ภายในแอป)', 'info'));
        }
        
        async function pasteData() {
            if (!$startCell) return displayMessage('โปรดเลือกช่องเริ่มต้นเพื่อวางข้อมูล', 'warning');
            
            let pasteContent;
            try {
                pasteContent = await navigator.clipboard.readText();
            } catch (err) {
                // Fallback to internal buffer if clipboard access fails
            }

            if (!pasteContent && copiedData) {
                pasteContent = copiedData.map(row => row.join('\t')).join('\n');
            }
            if (!pasteContent) return displayMessage('ไม่มีข้อมูลในคลิปบอร์ดเพื่อวาง', 'error');

            const pasteRows = pasteContent.split(/\r\n?|\n/).map(row => row.split('\t'));
            
            // This is a complex operation, so we don't use performDataOperation.
            // We'll manage the state update manually.
            updateSheetData(); // Sync DOM to workbook state first
            
            let data = XLSX.utils.sheet_to_json(currentWorkbook.Sheets[activeSheetName], {header: 1, defval: ''});
            const startR = $startCell.data('r');
            const startC = $startCell.data('c');

            // 1. Paste text data into the data array
            pasteRows.forEach((row, rOffset) => {
                const targetR_data = startR + rOffset + 1; // data array's content starts at index 1
                if (!data[targetR_data]) data[targetR_data] = [];
                row.forEach((value, cOffset) => {
                    const targetC_data = startC + cOffset;
                    data[targetR_data][targetC_data] = value;
                });
            });

            // 2. Handle merges
            let currentMerges = sheetMerges[activeSheetName] || [];
            const pasteEndR = startR + pasteRows.length - 1;
            const pasteEndC = startC + (pasteRows[0] || []).length - 1;

            // 2a. Remove any existing merges that overlap with the paste area
            currentMerges = currentMerges.filter(merge => {
                const overlap = !(merge.e.c < startC || merge.s.c > pasteEndC || merge.e.r < startR || merge.s.r > pasteEndR);
                return !overlap; // Keep merges that do NOT overlap
            });

            // 2b. Add the new merges from the copied data, translated to the new position
            if (copiedMerges.length > 0) {
                copiedMerges.forEach(relMerge => {
                    currentMerges.push({
                        s: { r: relMerge.s.r + startR, c: relMerge.s.c + startC },
                        e: { r: relMerge.e.r + startR, c: relMerge.e.c + startC }
                    });
                });
            }
            
            sheetMerges[activeSheetName] = currentMerges;

            // 3. Update sheet object and re-render the table
            const newSheet = XLSX.utils.aoa_to_sheet(data);
            newSheet['!merges'] = sheetMerges[activeSheetName];
            currentWorkbook.Sheets[activeSheetName] = newSheet;
            
            renderSheet(activeSheetName);
            saveState(false); // Save the new state without reading from DOM again
            
            // 4. Re-select the pasted area for user feedback
            setTimeout(() => {
                const $first = $(`td[data-r="${startR}"][data-c="${startC}"]`);
                const $last = $(`td[data-r="${pasteEndR}"][data-c="${pasteEndC}"]`);
                if ($first.length) {
                    selectCell($first);
                    if($last.length) updateCellSelection($last);
                }
            }, 0);
            displayMessage('วางข้อมูลเรียบร้อยแล้ว', 'success');
        }

        // --- Utility & UI Functions ---
        function updateRowCount() {
            const totalRows = $('#excel-table tbody tr').length || 0;
            const visibleRows = $('#excel-table tbody tr:visible').length || 0;
            const totalCols = ($('#excel-table thead tr:first-child th').length - 1) || 0;
            const statusText = (Object.keys(activeFilters).length > 0 && visibleRows !== totalRows)
                ? `พบ ${visibleRows} จาก ${totalRows} แถว`
                : `แถว: ${totalRows} | คอลัมน์: ${totalCols}`;
            $('#table-status-bar').text(statusText);
        }

        function displayMessage(title, type) {
            Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer);
                    toast.addEventListener('mouseleave', Swal.resumeTimer);
                }
            }).fire({ icon: type, title: title });
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('conversionHistory') || '[]');
            const $list = $('#history-list').empty();
            $('#empty-history-message').toggle(history.length === 0);
            history.forEach(entry => $list.append(createHistoryElement(entry)));
        }

        function addHistoryEntry(originalName, convertedName) {
            let history = JSON.parse(localStorage.getItem('conversionHistory') || '[]');
            history.unshift({ originalName, convertedName, date: new Date().toISOString() });
            localStorage.setItem('conversionHistory', JSON.stringify(history.slice(0, 50)));
            loadHistory();
        }
        
        function createHistoryElement({date, originalName, convertedName}) {
             const formattedDate = new Date(date).toLocaleString('th-TH', { dateStyle: 'short', timeStyle: 'short' });
             return `
                <li data-date="${date}" class="flex items-center justify-between bg-gray-50 p-3 rounded-lg border">
                    <div class="flex items-center gap-3 flex-grow min-w-0">
                        <svg class="w-8 h-8 text-green-500 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <div class="min-w-0">
                            <p class="font-medium text-gray-800 truncate" title="${originalName}">${originalName}</p>
                            <p class="text-sm text-gray-500">${formattedDate}</p>
                        </div>
                    </div>
                    <div class="text-right flex-shrink-0 ml-4">
                         <p class="text-sm font-medium text-gray-600 truncate" title="${convertedName}">${convertedName}</p>
                         <p class="text-xs text-gray-500">บันทึกในดาวน์โหลด</p>
                    </div>
                    <button class="delete-history-item-btn ml-2 p-2 rounded-full hover:bg-red-100 text-gray-500 hover:text-red-600 transition-colors flex-shrink-0">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </li>`;
        }

        function deleteHistoryItem(itemDate) {
            let history = JSON.parse(localStorage.getItem('conversionHistory') || '[]').filter(item => item.date !== itemDate);
            localStorage.setItem('conversionHistory', JSON.stringify(history));
            loadHistory();
            displayMessage('ลบรายการแล้ว', 'success');
        }

        function clearHistory() {
            localStorage.removeItem('conversionHistory');
            loadHistory();
            displayMessage('ล้างประวัติเรียบร้อยแล้ว', 'success');
        }
    </script>
</body>
</html>
